#!/bin/bash

set -e

CONTAINER=grr_container
MAX_START_WAIT_SECS=300
DOCKER_IP_NAME_PAIR=( $(tail /etc/hosts -n 1 | sed 's/\t/ /g') )
DOCKER_IP="${DOCKER_IP_NAME_PAIR[0]}"
DOCKER_HOSTNAME="${DOCKER_IP_NAME_PAIR[1]}"

# grep doesn't work in Docker-cloud: https://cloud.docker.com/swarm/demonchild2112/repository/registry-1.docker.io/demonchild2112/grr/builds/c2acb3e6-097c-49b0-8e29-a1597779bf4b
function wait_for_container_to_start() {
  echo "Waiting for container to start.."
  poll_start=$(date +%s)
  while true; do
    ready_msg="$(docker logs ${CONTAINER} 2>&1 | perl -wln -e 'print if /\bAdmin UI gui is at\b/')"
    if [[ ! -z "${ready_msg}" ]]; then
      break
    fi
    secs_elapsed=$(( $(date +%s) - $poll_start ))
    if [[ $secs_elapsed -gt $MAX_START_WAIT_SECS ]]; then
      echo "Error: Container has not started after ${MAX_START_WAIT_SECS} seconds."
      exit 1
    fi
    echo 'Container is not ready. Sleeping for 5 seconds..'
    sleep 5
  done
  echo "Container is ready."
}

function install_deps() {
  echo "Installing dependencies.."
  apt update && apt install -y \
      debhelper \
      default-jre \
      dpkg-dev \
      libffi-dev \
      libssl-dev \
      python-dev \
      python-pip \
      wget \
      zip
}

function start_container() {
  echo "Starting container.."
  echo "Docker ip-hostname: ${DOCKER_IP}-${DOCKER_HOSTNAME}"
  # Run demo container in background and send its logs to the systemd journal.
  docker run -d \
      --env EXTERNAL_HOSTNAME="${DOCKER_HOSTNAME}" \
      --env ADMIN_PASSWORD="demo" \
      --publish ${DOCKER_IP}:8000:8000 \
      --publish ${DOCKER_IP}:8080:8080 \
      --log-driver=journald \
      --name "${CONTAINER}" \
      demonchild2112/grr
}

ps aux

cat /etc/hosts

netstat

# See https://askubuntu.com/questions/365911/why-the-services-do-not-start-at-installation
echo "Replacing return code in policy-rc.d"
sed -i 's/exit 101/exit 0/g' /usr/sbin/policy-rc.d

start_container

# install_deps

wait_for_container_to_start

docker cp grr_container:/usr/share/grr-server/executables/installers/grr_3.2.0.0_amd64.deb .

dpkg -i grr_3.2.0.0_amd64.deb

service grr status

sleep 20

docker logs "${CONTAINER}" 1>container.log 2>&1

cat container.log

apt install -y wget

docker ps -a

wget ${DOCKER_IP}:8080/server.pem

cat server.pem

docker exec "${CONTAINER}" /usr/share/grr-server/bin/grr_console --code_to_execute "print(client_index.CreateClientIndex().LookupClients([]))"
